# Title: CVE-2025-6773 : Path traversal via file upload in LightRAG HKU.
### Effected Vendor: https://github.com/HKUDS/LightRAG/
### Originally found by: Hannibal0x
### Affected Version: <1.4.0
### CVSS Score: 4.8
### Criticality: Medium

---

## 1. Vulnerability Overview

LightRAG is a lightweight, open-source framework for retrieval-augmented generation (RAG) that combines knowledge graphs with vector embeddings to improve how large language models retrieve and understand information. It helps developers build smarter AI systems that can search, reason, and generate answers based on both structured (graph) and unstructured (text) data.

Affected versions of this package are vulnerable to Directory Traversal via the `upload_to_input_dir` function in the file `api/routers/document_routes.py`. An attacker can access or modify files outside the intended directory by manipulating the `file.filename` argument during file upload.

---

## 2. Root Cause Analysis

The vulnerability stemmed from directly using `file.filename` to construct the file path without proper validation. This meant that a malicious user could craft a filename like `../../../etc/passwd` to write files to arbitrary locations on the server's file system, potentially leading to unauthorized access or system compromise.

### How the Fix Was Applied

The fix was applied by introducing a new function called `sanitize_filename(filename: str, input_dir: Path) -> str`. This function is responsible for validating and cleaning uploaded filenames to ensure they are safe before being used in file path construction.

Here's a breakdown of the steps taken within `sanitize_filename()`:

* **Basic Validation:** It checks if the filename is empty or consists solely of whitespace.
* **Removal of Path Separators and Traversal Sequences:** It removes common path separators (`/`, `\`) and directory traversal sequences (`..`).
* **Removal of Control Characters and Null Bytes:** It filters out control characters and null bytes.
* **Removal of Leading/Trailing Whitespace and Dots:** It strips any leading/trailing whitespace and dots from the cleaned filename.
* **Empty Filename Check:** After sanitization, it verifies that the filename is not empty.
* **Path Verification:** Crucially, it uses `Path.resolve()` to get the absolute and normalized path of the intended file and then confirms that this `final_path` is a sub-path of the `input_dir.resolve()`. This ensures that the file is written strictly within the designated upload directory.

**Github Commit:** https://github.com/HKUDS/LightRAG/commit/60777d535b719631680bcf5d0969bdef79ca4eaf

---

## Resources:

* https://security.snyk.io/vuln/SNYK-PYTHON-LIGHTRAGHKU-10734126
* https://nvd.nist.gov/vuln/detail/CVE-2025-6773
